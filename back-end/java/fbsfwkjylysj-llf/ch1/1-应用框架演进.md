

# 第 1 章 应用框架演进

## 1.1 传统垂直应用架构

通过将业务公共能力抽象成原子服务，对复杂应用进行水平拆分和服务化，实现服务消费者和提供者的解耦。

* 架构
  * LAMP
  * MVC
  * EJB

### 1.1.1 垂直应用架构介绍

* MVC
  * 展示层（View）：展示业务数据，接收用户输入，不执行业务逻辑，不改变数据模型
  * 控制层（Control）：请求的分发，调度后台业务执行，调用视图返回数据
  * 模型层（Model）：业务数据和业务执行逻辑
  * 标准的MVC不包含数据访问层：屏蔽了底层的数据连接池和数据源实现
* 补救
  * 热双机
  * 服务端监听浮动IP
  * Watch Dog检测应用进程
  * F5或SLB等负载均衡

### 1.1.2 垂直应用架构面临的挑战

* 弊端
  * 应用开发成本高，部署效率低
  * 团队协作效率差，代码重复率高
  * 系统可靠性差
  * 维护和定制困难
  * 新功能上线周期变长
    * 公共API变更导致测试工作量激增
    * 新特性无法独立部署和交付

## 1.2 RPC架构

* RPC（Remote Procedure Call）：允许像调用本地服务一样调用远程服务
  * Spring HTTP Invoker
  * Facebook Thrift
* 优点
  * 简单
  * 高效
  * 通用

### 1.2.1 RPC框架原理

* RPC功能
  * 屏蔽底层的传输方式（TCP或UDP）
  * 序列化方式（XML/JSON/二进制）
  * 通信细节
* 技术点
  * 远程服务提供者需要以某种形式提供服务调用相关的信息
  * 远程代理对象：服务调用者调用的服务实际是远程服务的本地代理
  * 通信：RPC框架与具体的协议无关。例如：Spring提供HTTP Invoke, RMI Invoke, MessagePack私有的二进制压缩协议
  * 序列化：将对象转换成二进制码流进行网络传输

### 1.2.2 最简单的RPC框架实现

不依赖第三方类库，实现最简单RPC框架

* Java原生技术
  * 序列化
  * Socket通信
  * 动态代理
  * 反射机制
* RPC框架组成
  * 服务提供者：提供服务接口定义和服务实现
  * 服务发布者：负责将本地服务发布成远程服务
  * 本地服务代理：通过代理调用远程服务提供者，将结果封装返回给本地消费者
* 代码
  * Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors())
  * executor.execute(new ExporterTask(server.accept()))
  * ObjectInputStream, ObjectOutputStream, Method.invoke
* 服务端 主要职责
  * 服务端，监听客户端的TCP连接
  * 将客户端发送的码流反序列化成对象，反射调用服务实现者，获取执行结果
  * 将执行结果对象反序列化，通过Socket发送给客户端
  * 远程服务调用完成后，释放Socket等连接资源
* 本地代理 主要功能
  * 将本地的接口调用转换成JDK的动态代理，在动态代理中实现接口的远程调用
  * 创建Socket客户端，根据指定地址连接远程服务提供者
  * 将远程服务调用所需的接口类、方法名、参数列表等编码后发送给服务调用者
* 测试代码
  * 创建一个异步发布服务端的线程并启动，用于接收RPC客户端请求
  * 创建客户端服务代理类，构造RPC请求参数，发起RPC调用

### 1.2.3 业界主流RPC框架

* 主流RPC框架
  * Facebook Apache Thrift
  * Hadoop Avro-RPC
  * caucho Hessian
  * Google gRPC
* Apache Thrift
  * 多语言远程服务调用框架
  * 采用接口描述语言（IDL）定义并创建服务
  * 可扩展的跨语言服务
  * 代码生成引擎
  * 采用二进制传输数据
  * 提供阻塞、非阻塞、单线程和多线程的模式
  * 通信协议
    * 二进制：省带宽，传输效率高
    * 文本：可读性高
    * 常用协议
      * TBinaryProtoco: 二进制编码格式数据传输协议
      * TCompactProtocl: 高效率的压缩二进制编码格式数据传输协议
      * TJSONProtocol: 使用JSON编码的数据传输协议
  * 通信方式
    * TSocket: 阻塞式I/O
    * TFramedTransport: 非阻塞，按块进行传输，类似于Java中NIO非阻塞通信
    * TNonblockingTransport: 非阻塞
* Apache Avro
  * 丰富数据结构类型
  * 快速可压缩的二进制数据形式
  * 存储持久数据的文件容器
  * 简单的动态语言结合功能
  * 特点
    * 支持动态模式：Avro不需要生成代码
    * 数据无须加标签
    * 无须手工分配的域标识
  * 优点，可定制性高
    * 传输层和业务逻辑层分离
    * 服务端有协议注册工厂和序列化注册工厂，可定制私有协议和不同序列化方式
    * 客户端支持同步和异步调用