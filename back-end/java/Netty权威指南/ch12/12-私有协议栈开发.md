
# 第12章 私有协议栈开发

* 通信协议
  * 公有协议
  * 私有协议
    * 大部分私有协议传输层都基于TPC/IP

## 12.1 私有协议介绍

* 私有协议
  * 厂商内部发展和采用的标准
  * 具有封闭性、垄断性、排他性
* 传统Java4种方式跨节点通信
  * RMI远程通信
  * Socket+Java序列化
  * 开源RPC：Thrift, Avro
  * 标准公有协议：HTTP+XML、RESTful+JSON、WebService

## 12.2 Netty 协议栈功能设计

### 12.2.1 网络拓扑图

* 长链接

### 12.2.2 协议栈功能描述

* 功能描述
  * 承载了业务内部各模块之间的消息交互和服务调用
  * 功能
    * NIO通信框架，高性能的异步通信能力
    * 消息的编解码框架，序列化和反序列化
    * IP白名单接入认证
    * 链路的有效性 校验机制
    * 链路的断连重连机制

### 12.2.3 通信模型

### 12.2.4 消息定义

* 消息定义两部分
  * 消息头
  * 消息体
* Netty消息定义表
  * header
  * body
* Netty协议消息头定义Header
 * crcCode：0XABEF+主版本号+次版本号
 * length
 * sessionID
 * type

### 12.2.5 Netty 协议支持的字段类型

### 12.2.6 Netty 协议的编解码规范

### 12.2.7 链路的建立

* Netty协议栈
  * Netty协议栈支持服务端和客户端
  * 由调用方主动发起连接
* 握手请求
  * 消息头type=3
* 握手应答
  * 消息头type=4
  * 消息体：0认证成功，-1认证失败

### 12.2.8 链路的关闭

* 关闭连接
  * 宕机或重启时
  * 读写消息发生IO异常
  * 读写心跳消息发生IO异常
  * 心跳超时

### 12.2.9 可靠性设计

* 可靠性设计
  * 心跳机制
    * 网络处于空闲状态持续时间达到T，客户端主动发送Ping心跳消息给服务端
    * 在下一个周期T到来时客户端没有收到对方发送的Pong心跳应答消息，心跳失败计数器加1
    * 客户端收到业务消息或Pong应答消息，心跳失败计数器清零
    * 连续N次没有收到服务端的Pong消息，关闭链路，间隔INTERVAL时间后发起重连操作
    * 服务端网络空闲状态持续时间达到T后，服务端将心跳失败计数器加1
    * 服务端收到客户端发送的Ping消息或者其他业务消息，计数器清零
    * 服务端连续N次没有收到客户端的Ping消息或者其他业务消息，则关闭链路