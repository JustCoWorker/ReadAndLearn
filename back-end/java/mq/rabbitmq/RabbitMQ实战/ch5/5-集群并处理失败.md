

# 第5章 集群并处理失败


## 5.1 开足马力：RabbitMQ集群

* RabbitMQ内建集群用于完成两个目标
  * 允许消费者和生产者在Rabbit节点崩溃的情况下继续运行
  * 添加更多的节点来线性扩展消息通信吞吐量
* 节点崩溃
  * 一个Rabbit集群节点崩溃时，该节点上队列的消息也会消失
  * RabbitMQ默认不会将队列的内容复制到整个集群上

## 5.2 集群架构

* RabbitMQ四种类型的内部元数据
  * 队列元数据
  * 交换器元数据
  * 绑定元数据：展示如何将消息路由到队列
  * vhost元数据：为vhost内的队列、交换器和绑定提供命名空间和安全属性
* 信息存储
  * 单一节点
    * 将所有的元数据存储在内存中
    * 将标记为可持久化的队列和交换器以及绑定存储到硬盘上
  * 引入集群
    * 新的元数据类型：`集群节点位置`
    * 节点与已记录的其他类型元数据的关系

### 5.2.1 集群中的队列

* 集群中的队列信息
  * 集群只会在单个节点而不是在所有节点上创建`完整的队列信息（元数据、状态、内容）`
  * 只有队列的所有者节点知道有关队列的`所有信息`
  * 所有其他非所有者节点只知道`队列的元数据`和指向该队列存在的那个`节点的指针`
* 默认请情况下RabbitMQ不将队列内容和状态复制到所有的节点
  * 存储空间：如果完整拷贝，新增节点不会带来更多的存储空间
  * 性能：如果需要复制消息到集群节点，新增节点，网络和磁盘负载都会增加
* 往Rabbit集群添加更多的节点意味着你将拥有更多的节点来传播`队列`，提升性能。

### 5.2.2 分布交换器

* 交换器
  * 队列拥有自己的进程
  * 交换器只是一个名称和一个队列绑定列表
  * 将消息发布到交换器时
  * 实际上是由信道将消息上的路由键同交换器的绑定列表进行比较
  * 信道（channel）按照绑定匹配的结果，将消息路由到队列
* 集群中的交换器
  * 交换器只不过是一张查询表
  * 集群中的每个节点拥有每个交换器的所有信息
* 避免丢失消息
  * 当与交换器在集群中完全复制的这一事实相结合时
  * `事务模式和发送方确认模式`都能确保应用程序一直发布而不丢失一条消息

### 5.2.3 是内存节点还是磁盘节点

* 内存节点将所有的队列、交换器、绑定、用户、权限和vhost的元数据定义都仅存储在内存中
* 磁盘节点则将元数据存储在磁盘中
* 单节点系统只运行磁盘类型的节点
* 集群可以选择配置部分节点为内存节点，加速操作

* 当在集群中声明队列、交换器或者绑定的时候，操作会直到所有集群节点都成功提交元数据变更后才返回
* RabbitMQ只要求在集群中至少有个磁盘节点。所有其他节点可以是内存节点

* 如果这一磁盘节点崩溃了，集群可以继续路由，但不能做以下操作
  * 创建队列
  * 创建交换器
  * 创建绑定
  * 添加用户
  * 更改权限
  * 添加或删除集群节点

* 在集群中设置两个磁盘节点
  * 至少有一个是可用的，能在任何时候保存元数据变更
  * 确保内存节点获知所有的磁盘节点的信息
  * 内存节点唯一存储到磁盘的元数据信息是集群中磁盘节点的地址

## 5.3 在你的笔记本电脑上设置集群

* 设置集群
  * 启动rabbitmq-server后，默认使用节点名称rabbit和监听端口号5672
  * 设置RABBITMQ_NODENAME和RABBITMQ_NODE_PORT环境变量指明节点名称和端口号

* 集群初始化过程
  * 集群中的第一个节点将初始元数据带入集群中
  * 第二个和之后的节点将加入它并且获取它的元数据
  * 加入节点前，首先需要停止Erlang节点上运行的RabbitMQ应用程序，并清空元数据
  