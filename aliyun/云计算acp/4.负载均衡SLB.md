1. https://help.aliyun.com/product/27537.html

# 2. 产品简介
## 2.1 什么是负载均衡
https://help.aliyun.com/document_detail/27539.html
> 负载均衡由以下三个部分组成：
  * 负载均衡实例 （Server Load Balancer instances）
    * 一个负载均衡实例是一个运行的负载均衡服务，用来接收流量并将其分配给后端服务器。要使用负载均衡服务，您必须创建一个负载均衡实例，并至少添加一个监听和两台ECS实例。
  * 监听 （Listeners）
    * 监听用来检查客户端请求并将请求转发给后端服务器。监听也会对后端服务器进行健康检查。
  * 后端服务器（Backend Servers）
    * 一组接收前端请求的ECS实例。您可以单独添加ECS实例到服务器池，也可以通过虚拟服务器组或主备服务器组来批量添加和管理。
## 2.2 基础架构
https://help.aliyun.com/document_detail/27544.html
阿里云当前提供四层（TCP协议和UDP协议）和七层（HTTP和HTTPS协议）的负载均衡服务。
* 四层采用开源软件LVS（Linux Virtual Server）+ keepalived的方式实现负载均衡，并根据云计算需求对其进行了个性化定制。
* 七层采用Tengine实现负载均衡。Tengine是由淘宝网发起的Web服务器项目，它在Nginx的基础上，针对有大访问量的网站需求，添加了很多高级功能和特性。
## 2.3 功能概述
https://help.aliyun.com/document_detail/32460.html
> 调度算法
  * 负载均衡支持轮询
  * 加权轮询（WRR）
  * 加权最小连接数（WLC）
  * 一致性哈希（CH）调度算法。
# 5. 用户指南
## 5.2 监听
### 5.2.4 添加HTTPS监听
https://help.aliyun.com/document_detail/86438.html
> 在上传证书前，请注意：
  * 上传的证书格式必须是PEM。详情参见证书要求。
  * 证书上传到负载均衡后，`负载均衡即可管理证书，不需要在后端ECS上绑定证书`。
### 5.2.8 监听介绍
https://help.aliyun.com/document_detail/85943.html
* 负载均衡提供四层（TCP/UDP协议）和七层（HTTP/HTTPS协议）监听
## 5.3 健康检查
### 5.3.1 健康检查介绍
https://help.aliyun.com/document_detail/85958.html
> UDP监听的检查机制如下：
  * LVS节点服务器根据监听的健康检查配置，向后端ECS的内网IP+【健康检查端口】发送UDP报文。
  * 如果后端ECS相应端口未正常监听，则系统会返回类似返回 port XX unreachable的ICMP报错信息；反之不做任何处理。
  * 如果在【响应超时时间】之内，LVS节点服务器收到了后端ECS返回的上述错误信息，则认为服务异常，判定健康检查失败。
  * 如果在【响应超时时间】之内，LVS节点服务器没有收到后端ECS返回的任何信息，则认为服务正常，判定健康检查成功。
> 健康检查时间窗
  * 健康检查机制的引入，有效提高了业务服务的可用性。但是，为了避免频繁的健康检查失败引起的切换对系统可用性的冲击，健康检查只有在健康检查时间窗内连续多次检查成功或失败后，才会进行状态切换。健康检查时间窗由以下三个因素决定：
    * 健康检查间隔 (每隔多久进行一次健康检查)
    * `响应超时时间` (等待服务器返回健康检查的时间)
    * 检查阈值 (健康检查连续成功或失败的次数)
  * 健康检查时间窗的计算方法如下：
    * 健康检查失败时间窗=响应超时时间×不健康阈值+检查间隔×(不健康阈值-1)
## 5.5 转换证书格式
### 5.5.5 转换证书格式
https://help.aliyun.com/document_detail/85970.html
* 负载均衡只支持PEM格式的证书，其它格式的证书需要转换成PEM格式后，才能上传到负载均衡。建议使用Open SSL进行转换。
## 5.8 监控
### 5.8.2 设置报警规则
https://help.aliyun.com/document_detail/85933.html
https://help.aliyun.com/document_detail/32470.html （旧）
# 6. API参考
## 6.1 API概览
https://help.aliyun.com/document_detail/27566.html
ModifyLoadBalancerInternetSpec	修改负载均衡实例的计费方式或规格。
## 6.4 RAM鉴权
https://help.aliyun.com/document_detail/27575.html
> 可授权的负载均衡资源类型
  * LoadBalancer
  * Certificate
  * ACL
## 6.9 后端服务器
https://help.aliyun.com/document_detail/27635.html
> ServerHealthStatus 后端服务器的健康状况：
  * normal：后端服务器健康。
  * abnormal：后端服务器不健康。
  * `unavailable`：未完成健康检查。
# 8 扩展阅读
## 8.1 最佳实践
https://help.aliyun.com/document_detail/27704.html
> 负载均衡服务提供会话保持功能。开启会话保持功能后，负载均衡会将会话期间内来自同一客户端的访问请求分发到同一台后端服务器上进行处理。
  * 四层监听的会话保持是`基于IP地址`的会话保持，负载均衡监听器会将来自同一IP地址的请求转发到同一个后端ECS上；
  * 而七层监听是`基于Cookie`的会话保持。
## 8.2 常见问题
### 8.2.2 负载均衡常见问题
https://help.aliyun.com/knowledge_detail/55193.html
> 负载均衡支持哪些调度算法？
  * 可以使用轮询、加权轮询（WRR）、加权最小连接数（WLC）这三种调度方法：
    * 轮询：按照访问次数依次将外部请求依序分发到后端ECS上。
    * 加权轮询：您可以对每台后端服务器设置权重值，权重值越高的服务器，被轮询到的次数（概率）也越高。
    * 加权最小连接数：除了根据每台后端服务器设定的权重值来进行轮询，同时还考虑后端服务器的实际负载（即连接数）。当权重值相同时，当前连接数越小的后端服务器被轮询到的次数（概率）也越高。
> 如何避免负载均衡服务本身的故障问题？
  * 添加不同可用区的ECS实例作为负载均衡实例的后端服务器，从而提高本地可用性。
  * 在同一地域创建多个负载均衡实例，通过DNS轮询的方式对外提供服务，从而提高本地可用性。
  * 在不同地域创建多个负载均衡实例，通过DNS轮询的方式对外提供服务，从而提高跨地域的可用性。
### 8.2.4 健康检查常见问题
https://help.aliyun.com/knowledge_detail/55205.html
> 3. 是否可以关闭健康检查？
  * 您`只可能关闭HTTP/HTTPS监听的健康检查，不能关闭TCP/UDP监听的健康检查`
### 8.2.8 为什么请求不均衡
https://help.aliyun.com/knowledge_detail/66280.html
> 负载均衡请求不均衡的原因可能有以下几种可能：
  * 开启了`会话保持`功能
    * 配置了会话保持，当访问负载均衡实例的客户端又很少时，容易导致不均衡，尤其在使用少量客户端对负载均衡进行测试的时候。比如TCP监听，开启了会话保持（四层是基于来源地址做会话保持），使用一台客户端对负载均衡实例进行压测，就会导致不均衡。
  * ECS`健康检查`异常
    * 后端服务器ECS的健康建状态异常会导致不均衡，尤其在压测的时候容易忽略后端服务器ECS的健康检查状态，如果有后端服务器ECS健康检查失败或者健康检查状态经常跳跃（好到坏，又从坏到好，反复变化）必然会导致不均衡。
  * TCP Keepalive保持长连接
    * 后端服务器ECS有些开启了TCP Keepalive保持长连接，而有些又没有开启，则连接会在保持长连接的后端服务器上堆积，造成不均衡。
> 排查和解决方法
  * 查看后端各台ECS的权重是否相同；
  * 在相关时间段内是否有健康检查失败或波动现象，查找波动的原因；或者健康检查没有配置正确的响应码2xx，3xx导致了健康检查显示正常，但后端服务有异常；
  * 是否同时使用了加权最小连接数（WLC）调度方式和会话保持，如果是，尝试改为加权加权轮询（WRR）算法和会话保持。
### 8.2.12 HTTPS/HTTP监听常见问题
https://help.aliyun.com/knowledge_detail/55201.html
7. 可以使用PKCS#12（PFX）格式的证书么？
可以。但在上传证书前，您需要将证书转换为PEM格式，详情参见转换证书格式。
# 其他
[SLB 配置获取真实IP](https://help.aliyun.com/knowledge_detail/60529.html)
X-Forwarded-For 是一个 HTTP 扩展头部，用来表示 HTTP 请求端真实 IP。
规划和准备
[规划与准备](https://help.aliyun.com/document_detail/27548.html)
> 为了提供更加稳定可靠的负载均衡服务，阿里云负载均衡已在各地域部署了多可用区以实现同地域下的跨机房容灾。此外，您也可以在不同地域创建多个负载均衡实例，`通过DNS轮询的方式对外提供服务，从而提高跨地域的可用性`。
* 为了减少延迟并提高下载速度，建议选择离您客户最近的地域。
* 由于负载均衡不支持跨地域部署，因此应选择与后端ECS实例相同的地域。
