#20170714 ruby §|§
input {
	beats {
		port => "5000"
	}
}

filter {
	ruby {
		code => 'msgs = event.get("message").split("§|§")
            event.set("time_local", msgs[0])
            event.set("hostname", msgs[1])
            event.set("remote_addr", msgs[2])
            event.set("remote_port", msgs[3])
            event.set("remote_user", msgs[4])
            event.set("scheme", msgs[5])
            event.set("request_method", msgs[6])
            event.set("uri", msgs[7])
            event.set("request_uri", msgs[8])
            event.set("request_filename", msgs[9])
            event.set("args", msgs[10])
            event.set("http_user_agent", msgs[11])
            event.set("http_referer", msgs[12])
            event.set("http_x_forwarded_for", msgs[13])
            event.set("content_length", msgs[14])
            event.set("content_type", msgs[15])
            event.set("body_bytes_sent", msgs[16])
            event.set("request_body", msgs[17])
            event.set("status", msgs[18])
            event.set("server_addr", msgs[19])
            event.set("server_name", msgs[20])
            event.set("server_port", msgs[21])
            event.set("server_protocol", msgs[22])
            event.set("request_time", msgs[23])
            event.set("upstream_response_time", msgs[24])
            event.set("proxy_add_x_forwarded_for", msgs[25])
            event.set("upstream_addr", msgs[26])
        '
	}
	mutate {
		convert => [
			"body_bytes_sent", "integer",
			"content_length", "integer",
			"server_port", "integer",
			"remote_port", "integer",
			"status", "integer",
			"upstream_response_time", "float",
			"request_time", "float"
		]
	}
	mutate {
		add_field => {
			"uris" => "%{uri}"
		}
	}
	mutate {
		split => {
			"uris" => "."
		}
		add_field => {
			"request_type" => "%{uris[-1]}"
		}
	}
}
output {
	elasticsearch {
		hosts => "elasticsearch:9200"
	}
	stdout {
		codec => rubydebug
	}
}




#20170714 split §|§ mutate
input {
    beats {
        port => "5000"
    }
}

filter {
     mutate {
          split=>["message","§|§"]
                add_field => {"time_local" => "%{[message][0]}"} 
                add_field => {"hostname" => "%{[message][1]}"}
                add_field => {"remote_addr" => "%{[message][2]}"}
                add_field => {"remote_port" => "%{[message][3]}"}
                add_field => {"remote_user" => "%{[message][4]}"}
                add_field => {"scheme" => "%{[message][5]}"}
                add_field => {"request_method" => "%{[message][6]}"}
                add_field => {"uri" => "%{[message][7]}"}
                add_field => {"request_uri" => "%{[message][8]}"}
                add_field => {"request_filename" => "%{[message][9]}"}
                add_field => {"args" => "(%{[message][10]})"}
                add_field => {"http_user_agent" => "%{[message][11]}"}
                add_field => {"http_referer" => "%{[message][12]}"}
                add_field => {"http_x_forwarded_for" => "%{[message][13]}"}
                add_field => {"content_length" => "%{[message][14]}"}
                add_field => {"content_type" => "%{[message][15]}"}
                add_field => {"body_bytes_sent" => "%{[message][16]}"}
                add_field => {"request_body" => "%{[message][17]}"}
                add_field => {"status" => "%{[message][18]}"}
                add_field => {"server_addr" => "%{[message][19]}"}
                add_field => {"server_name" => "%{[message][20]}"}
                add_field => {"server_port" => "%{[message][21]}"}
                add_field => {"server_protocol" => "%{[message][22]}"}
                add_field => {"request_time" => "%{[message][23]}"}
                add_field => {"upstream_response_time" => "%{[message][24]}"}
                add_field => {"proxy_add_x_forwarded_for" => "%{[message][25]}"}
                add_field => {"upstream_addr" => "%{[message][26]}"}
                #remove_field => ["message"]
        }	
    mutate {
	  add_field => {
        "uris" => "%{uri}"
      }
	}
    mutate {
      split => { "uris" => "." }
      add_field => {
       "request_type" => "%{uris[-1]}"
      }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}




#20170714 split uris 无法处理/data/html/www/cloud/webjars/springfox-swagger-ui/swagger-ui.min.js -1
#%{uris[-1]} 取尾部的值
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{HTTPDATE:time_local} %{HOSTNAME:hostname} %{IPORHOST:remote_addr} %{NUMBER:remote_port:int} (%{USER:remote_user}|-) %{WORD:scheme} %{WORD:request_method} %{URIPATHPARAM:uri} %{URIPATHPARAM:request_uri} %{URIPATHPARAM:request_filename} (%{DATA:args}|-) (\[%{DATA:http_user_agent}\]|-) (%{DATA:http_referer}|-) (%{DATA:http_x_forwarded_for}|-) (%{NUMBER:content_length:int}|-) (%{DATA:content_type}|-) (%{NUMBER:body_bytes_sent:int}|-) (%{DATA:request_body}|-) (%{NUMBER:status:int}|-) %{IP:server_addr} (%{DATA:server_name}|-) (%{NUMBER:server_port:int}|-) (%{DATA:server_protocol}|-) (%{NUMBER:request_time:float}|-) (%{NUMBER:upstream_response_time:float}|-) (%{DATA:proxy_add_x_forwarded_for}|-) (%{GREEDYDATA:upstream_addr}|-)'}
    }
	
    mutate {
	  add_field => {
        "uris" => "%{uri}"
      }
	}
    mutate {
      split => { "uris" => "." }
      add_field => {
       "request_type" => "%{uris[-1]}"
      }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}

#20170708 split uris 注意mutate一定要分开，先新增字段uris，后进行拆分split
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{HTTPDATE:time_local} %{HOSTNAME:hostname} %{IPORHOST:remote_addr} %{NUMBER:remote_port:int} (%{USER:remote_user}|-) %{WORD:scheme} %{WORD:request_method} %{URIPATHPARAM:uri} %{URIPATHPARAM:request_uri} %{URIPATHPARAM:request_filename} (%{DATA:args}|-) (\[%{DATA:http_user_agent}\]|-) (%{DATA:http_referer}|-) (%{DATA:http_x_forwarded_for}|-) (%{NUMBER:content_length:int}|-) (%{DATA:content_type}|-) (%{NUMBER:body_bytes_sent:int}|-) (%{DATA:request_body}|-) (%{NUMBER:status:int}|-) %{IP:server_addr} (%{DATA:server_name}|-) (%{NUMBER:server_port:int}|-) (%{DATA:server_protocol}|-) (%{NUMBER:request_time:float}|-) (%{NUMBER:upstream_response_time:float}|-) (%{DATA:proxy_add_x_forwarded_for}|-) (%{GREEDYDATA:upstream_addr}|-)'}
    }
	
    mutate {
	  add_field => {
        "uris" => "%{uri}"
      }
	}
    mutate {
      split => { "uris" => "." }
      add_field => {
       "request_type" => "%{uris[1]}"
      }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}

#20170707 新增%{PATTERN_NAME:capture_name:data_type} data_type 目前只支持两个值：int 和 float。
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{HTTPDATE:time_local} %{HOSTNAME:hostname} %{IPORHOST:remote_addr} %{NUMBER:remote_port:int} (%{USER:remote_user}|-) %{WORD:scheme} %{WORD:request_method} %{URIPATHPARAM:uri} %{URIPATHPARAM:request_uri} %{URIPATHPARAM:request_filename} (%{DATA:args}|-) (\[%{DATA:http_user_agent}\]|-) (%{DATA:http_referer}|-) (%{DATA:http_x_forwarded_for}|-) (%{NUMBER:content_length:int}|-) (%{DATA:content_type}|-) (%{NUMBER:body_bytes_sent:int}|-) (%{DATA:request_body}|-) (%{NUMBER:status:int}|-) %{IP:server_addr} (%{DATA:server_name}|-) (%{NUMBER:server_port:int}|-) (%{DATA:server_protocol}|-) (%{NUMBER:request_time:float}|-) (%{NUMBER:upstream_response_time:float}|-) (%{DATA:proxy_add_x_forwarded_for}|-) (%{GREEDYDATA:upstream_addr}|-)'}
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}


#20170707 完整版
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{HTTPDATE:time_local} %{HOSTNAME:hostname} %{IPORHOST:remote_addr} %{NUMBER:remote_port} (%{USER:remote_user}|-) %{WORD:scheme} %{WORD:request_method} %{URIPATHPARAM:uri} %{URIPATHPARAM:request_uri} %{URIPATHPARAM:request_filename} (%{DATA:args}|-) (\[%{DATA:http_user_agent}\]|-) (%{DATA:http_referer}|-) (%{DATA:http_x_forwarded_for}|-) (%{NUMBER:content_length}|-) (%{DATA:content_type}|-) (%{NUMBER:body_bytes_sent}|-) (%{DATA:request_body}|-) (%{NUMBER:status}|-) %{IP:server_addr} (%{DATA:server_name}|-) (%{NUMBER:server_port}|-) (%{DATA:server_protocol}|-) (%{NUMBER:request_time}|-) (%{NUMBER:upstream_response_time}|-) (%{DATA:proxy_add_x_forwarded_for}|-) (%{GREEDYDATA:upstream_addr}|-)'}
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}


#20170707 file beats
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{IPORHOST:remoteAddr} (?:%{USER:ident}|-) (?:%{USER:remoteUser}|-) \[%{HTTPDATE:timeLocal}\] \"(?:%{WORD:verb} %{URIPATHPARAM:request}(?: HTTP/%{NUMBER:httpversion})?|)\" %{NUMBER:status} (?:%{NUMBER:bodyTytesSent}|-) (?:%{NUMBER:requestTime}|-) (?:%{NUMBER:upstreamResponseTime}|-) (?:%{URIPATHPARAM:upstreamAddr}|%{HOSTPORT:upstreamAddr}|-)' }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}

#20170705 file beats
input {
    beats {
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{IPORHOST:remote_addr} (?:%{USER:ident}|-) (?:%{USER:remote_user}|-) \[%{HTTPDATE:time_local}\] \"(?:%{WORD:verb} %{URIPATHPARAM:request}(?: HTTP/%{NUMBER:httpversion})?|)\" %{NUMBER:status} (?:%{NUMBER:body_bytes_sent}|-) (?:%{NUMBER:request_time}|-) (?:%{NUMBER:upstream_response_time}|-) (?:%{URIPATHPARAM:upstream_addr}|%{HOSTPORT:upstream_addr}|-)' }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
    stdout{codec => rubydebug}
}


'$remote_addr - $remote_user [$time_local] "$request" '
'$status $body_bytes_sent $request_time $upstream_response_time $upstream_addr  "$http_referer" '
'"$http_user_agent" "$http_x_forwarded_for"'
192.168.31.212 - admin [05/Jul/2017:14:52:40 +0800] "GET /api/v1/nodes?resourceVersion=3987195&timeoutSeconds=401&watch=true HTTP/2.0" 200 1354346 400.994 400.994 192.168.31.221:6443  "-" "prometheus/discovery" "-"

#20170705修改版本
input {
    tcp {
        host => "0.0.0.0"
        port => "5000"
    }
}

filter {
    grok {
        match => { 'message' => '%{IPORHOST:remote_addr} (?:%{USER:ident}|-) (?:%{USER:remote_user}|-) \[%{HTTPDATE:time_local}\] \"(?:%{WORD:verb} %{URIPATHPARAM:request}(?: HTTP/%{NUMBER:httpversion})?|)\" %{NUMBER:status} (?:%{NUMBER:body_bytes_sent}|-) (?:%{NUMBER:request_time}|-) (?:%{NUMBER:upstream_response_time}|-) (?:%{URIPATHPARAM:upstream_addr}|%{HOSTPORT:upstream_addr}|-)' }
    }
}
output {
    elasticsearch {
        hosts => "elasticsearch:9200"
    }
	stdout{codec => rubydebug}
}

#20170705简略版
input {
        tcp {
                port => 5000
        }
}

## Add your filters / logstash plugins configuration here

output {
        elasticsearch {
                hosts => "elasticsearch:9200"
        }
}


#20170705原版
input {
    beats {
        host => "0.0.0.0"
        port => "5000"
    }
}
filter {
    if [type] == "nginx-access" {
        grok {
            match => { 'message' => '%{IPORHOST:clientip} %{USER:ident} %{USER:agent} \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:verb} %{URIPATHPARAM:request}(?: HTTP/%{NUMBER:httpversion})?|)\" %{NUMBER:answer} (?:%{NUMBER:byte}|-) (?:\"(?:%{URI:referrer}|-))\" (?:%{QS:referree}) %{QS:agent}' }
         }
         geoip {
             source => "clientip"
             target => "geoip"
             database => "/etc/logstash/GeoLiteCity.dat"
             add_field => [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
             add_field => [ "[geoip][coordinates]", "%{[geoip][latitude]}" ]
        }
        mutate {
             convert => [ "[geoip][coordinates]", "float" ]
       }
   }
}
output {
    stdout {
        codec => rubydebug
    }
    elasticsearch {
        hosts => ["127.0.0.1:9200"]
        user => beats
        password => beatspassword
    }
}